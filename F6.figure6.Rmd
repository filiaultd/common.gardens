---
title: "F6.figure6"
author: "Daniele Filiault"
date: "7/23/2021"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(glue)
library(ggplot2)
library(viridis)
library(RColorBrewer)
library(grid)
library(ggpubr)
```

## Introduction

Generates figure 6 of manuscript. 
Results of rotations done in script(s) 53 to do genome rotation to get empirical distributions of Kologorov-Smirnov test values obtained in script 52 testing selection scan genome subsets vs entire genome distributions of AF, AFD, home beta.  See also script 54 for initial analysis

## 01. load data

```{r load data}
scans <- c("n.scan.rot", "s.scan.rot", "n.gea.rot", "s.gea.rot","n.fit.rot", "s.fit.rot")
vars <- c("n.sweep.rot", "s.sweep.rot", "n.gea.rot", "s.gea.rot","n.fit.rot", "s.fit.rot")
all.dat <- as.list(1:length(scans))
for(up in 1:length(scans)){
  #print(up)
  up.scan <- scans[up]
  #print(up.scan)
  up.var <- vars[up]
  #print(up.var)
  up.files <- glue('./data/53.data/{up.scan}.{1:25}.Rdat')
  for(up.f in up.files){
    load(up.f)
    up.dat <- do.call(rbind, get(up.var))
    if(exists("out.dat")){out.dat <- rbind(out.dat, up.dat)
    }else{out.dat <- up.dat}
  }
  out.dat <- unique(out.dat)
  out.dat$scan.type <- up.scan
  all.dat[[up]] <- out.dat
  rm(out.dat)
}
all.dat <- do.call(rbind, all.dat)

### at the moment, missing 1 fitness scans.  Need to rerun north fitness.
#all.dat <- all.dat[all.dat$exp!=4,]
all.dat <- all.dat[all.dat$exp!=5,]
all.dat$scan.type <-  substring(all.dat$scan.type,3)
all.dat$exp.site <- do.call(rbind,strsplit(all.dat$exp, "_"))[,1]
all.dat$year <- do.call(rbind,strsplit(all.dat$exp, "_"))[,2]

```

## 02. get number of rotations with smaller KS than observed for all exp/year by scan combinations

```{r get nrotations smaller than observed}
expnames <- unique(all.dat$exp)
scannames <- unique(all.dat$scan)

scan.pvals <- as.list(1:length(expnames))
for(up in 1:length(expnames)){
  up.exp <- expnames[up]
  oe.dat <- sapply(1:length(scannames), function(up.s){
    up.scan <- scannames[up.s]
    up.dat <- all.dat[all.dat$scan==up.scan & all.dat$exp==up.exp,]
    n.af <- sum(up.dat$af.statistic < up.dat[up.dat$rotation=="observed","af.statistic"])
    n.afd <- sum(up.dat$afd.statistic < up.dat[up.dat$rotation=="observed","afd.statistic"])
    n.beta <- sum(up.dat$beta.statistic < up.dat[up.dat$rotation=="observed","beta.statistic"])
    out.dat <- unique(up.dat[,colnames(up.dat)%in%c("exp","scan","scan.type","exp.site", "year")])
    out.dat$n.af <- n.af
    out.dat$n.afd <- n.afd
    out.dat$n.beta <- n.beta
    return(out.dat)
      })
  oe.dat <- t(oe.dat)
  scan.pvals[[up]] <- oe.dat
}

scan.pvals <- do.call(rbind, scan.pvals)
scan.pvals <- apply(scan.pvals, 2, as.character)
scan.pvals <- as.data.frame(scan.pvals, stringsAsFactors=FALSE)
scan.pvals$scan.type <- gsub(".rot", "", scan.pvals$scan.type)
scan.pvals$n.af <- as.numeric(scan.pvals$n.af)
scan.pvals$n.afd <- as.numeric(scan.pvals$n.afd)
scan.pvals$n.beta <- as.numeric(scan.pvals$n.beta)

## get proportions of rotations < observed
n.rotations <- 1000
scan.pvals$p.af <- scan.pvals$n.af/n.rotations
scan.pvals$p.afd <- scan.pvals$n.afd/n.rotations
scan.pvals$p.beta <- scan.pvals$n.beta/n.rotations

```

## 03. plot these "empirical pvalues" by experiment, one plot per scan type for clarity

```{r generate AF/AFD and beta pval plots}
types <- unique(scan.pvals$scan.type)
scan.pvals$exp.site <- gsub("ADA", "NA", scan.pvals$exp.site)
scan.pvals$exp.site <- gsub("RAM", "NM", scan.pvals$exp.site)
scan.pvals$exp.site <- gsub("RAT", "SR", scan.pvals$exp.site)
scan.pvals$exp.site <- gsub("ULL", "SU", scan.pvals$exp.site)

type.af.plots <- as.list(1:3)
type.afd.plots <- as.list(1:3)

types.af <- c("A  selection scan", "B  genotype environment association", "C  field fitness")
pals <- c("Set2","Accent","Set1")
types.afd <- c("D", "E", "F")

for(up in 1:length(types)){
  up.t <- types[up]
  up.title.af <- types.af[up]
  up.title.afd <- types.afd[up]
  up.pal <- pals[up] 
  
  af.pplot <- ggplot(data=scan.pvals[scan.pvals$scan.type==up.t,], aes(x=p.beta, y=p.af, color=scan)) +
    geom_point() +
    facet_grid(year~exp.site) +
    scale_color_brewer(palette=up.pal, name="scan name") +
    #scale_colour_viridis_d(name="scan name") +
    xlab("proportion of rotations with KS less than observed (beta)") +
    ylab("proportion of rotations with \nKS less than observed \n(allele frequency)") +
    theme_bw() +
    ggtitle(up.title.af) +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    xlim(0,1) +
    ylim(0,1)
  type.af.plots[[up]] <- af.pplot
  
  afd.pplot <- ggplot(data=scan.pvals[scan.pvals$scan.type==up.t,], aes(x=p.beta, y=p.afd, color=scan)) +
    geom_point() +
    facet_grid(year~exp.site) +
    scale_color_brewer(palette=up.pal, name="scan name") +
    xlab("proportion of rotations with KS less than observed (beta)") +
    ylab("proportion of rotations with \nKS less than observed \n(allele frequency difference)") +
    theme_bw() +
    ggtitle(up.title.afd)+
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    xlim(0,1) +
    ylim(0,1)
  type.afd.plots[[up]] <- afd.pplot
  }

```

## 04. generate single figures from figures in 03
```{r consolidate AF figures}

af.figure <- ggarrange(type.af.plots[[1]] + rremove("ylab") + rremove("xlab"), type.af.plots[[2]] + rremove("ylab") + rremove("xlab"), type.af.plots[[3]] + rremove("ylab") + rremove("xlab"), # remove axis labels from plots
                    labels = NULL,
                    ncol = 1, nrow = 3,
                    common.legend = FALSE,
                    align = "hv", 
                    legend="none",
                    font.label = list(size = 10, color = "black", face = "bold", family = NULL, position = "top"))

af.figure <- annotate_figure(af.figure, left = textGrob("proportion of rotations with KS less than observed (allele frequency)", rot = 90, vjust = 1, gp = gpar(cex = 1)))

```

```{r consolidate AFD figures}

afd.figure <- ggarrange(type.afd.plots[[1]] + rremove("ylab") + rremove("xlab"), type.afd.plots[[2]] + rremove("ylab") + rremove("xlab"), type.afd.plots[[3]] + rremove("ylab") + rremove("xlab"), # remove axis labels from plots
                    labels = NULL,
                    ncol = 1, nrow = 3,
                    common.legend = FALSE,
                    align = "hv", 
                    legend="none",
                    font.label = list(size = 10, color = "black", face = "bold", family = NULL, position = "top"))

afd.figure <- annotate_figure(afd.figure, left = textGrob("proportion of rotations with KS less than observed (allele frequency difference)", rot = 90, vjust = 1, gp = gpar(cex = 1)))

```

```{r consolidate legends}
legend_scan <- get_legend(type.af.plots[[1]])
legend_gea <- get_legend(type.af.plots[[2]])
legend_fit <- get_legend(type.af.plots[[3]])

all.legends <- plot_grid(legend_scan, legend_gea, legend_fit, ncol=1, align = "v")
```

## 05. assemble final figure from these pieces

```{r assembled figure}
data.fig <- ggarrange(af.figure, NULL, afd.figure, ncol=3, common.legend=FALSE, widths=c(1, 0.07, 1))
data.fig <- annotate_figure(data.fig,bottom = textGrob("proportion of rotations with KS less than observed (home beta)", gp = gpar(cex = 1)))

assembled.fig <- ggarrange(data.fig, NULL, all.legends, ncol=3, common.legend=FALSE, widths = c(6,0.08, 0.9))

ggsave(assembled.fig, file="./manuscript.figures/Figure6.jpg", width=12, height=8.5)
```


